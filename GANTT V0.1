import tkinter as tk
from tkinter import ttk
import datetime

# --- Configuración y Utilidades ---
TRANS_COLOR = "gray" # Color para interacciones

def strip_time(date):
    return date.replace(hour=0, minute=0, second=0, microsecond=0)

def add_days(date, days):
    return date + datetime.timedelta(days=days)

def date_diff(start, end):
    return (end - start).days

# --- Datos Iniciales (Similar a la App React) ---
INITIAL_TASKS = [
    {"id": 1, "name": "Planificación", "start": strip_time(datetime.datetime.now()), "duration": 10, "color": "#3b82f6", "level": 0},
    {"id": 2, "name": "Diseño UI", "start": add_days(datetime.datetime.now(), 2), "duration": 5, "color": "#10b981", "level": 1},
    {"id": 3, "name": "Desarrollo", "start": add_days(datetime.datetime.now(), 8), "duration": 15, "color": "#6366f1", "level": 0},
    {"id": 4, "name": "Backend", "start": add_days(datetime.datetime.now(), 8), "duration": 7, "color": "#a855f7", "level": 1},
    {"id": 5, "name": "Frontend", "start": add_days(datetime.datetime.now(), 12), "duration": 10, "color": "#ec4899", "level": 1},
]

class GanttApp(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Python Gantt Reasoning Demo")
        self.geometry("1000x600")

        # --- Estado ---
        self.tasks = INITIAL_TASKS
        self.col_width = 40  # Zoom inicial (px por día)
        self.row_height = 40
        self.header_height = 50
        self.sidebar_width = 250
        self.start_date = strip_time(datetime.datetime.now()) - datetime.timedelta(days=2)
        
        # Variables para Drag & Drop
        self.dragging_item = None
        self.drag_data = {"x": 0, "start_date": None, "task_idx": None}
        
        self._setup_ui()
        self.draw_gantt()

    def _setup_ui(self):
        # 1. Barra Superior (Controles)
        toolbar = tk.Frame(self, bd=1, relief=tk.RAISED)
        toolbar.pack(side=tk.TOP, fill=tk.X)

        tk.Label(toolbar, text="Zoom:").pack(side=tk.LEFT, padx=5)
        self.scale_var = tk.DoubleVar(value=40)
        scale = tk.Scale(toolbar, from_=20, to=100, orient=tk.HORIZONTAL, variable=self.scale_var, command=self.on_zoom_change)
        scale.pack(side=tk.LEFT, padx=5)

        tk.Button(toolbar, text="Añadir Tarea", command=self.add_task).pack(side=tk.RIGHT, padx=10, pady=5)

        # 2. Panel Principal
        main_pane = tk.PanedWindow(self, orient=tk.HORIZONTAL)
        main_pane.pack(fill=tk.BOTH, expand=True)

        # 3. Lista de Tareas (Izquierda)
        self.tree = ttk.Treeview(main_pane, columns=("Start", "Dur"), show="tree headings")
        self.tree.heading("#0", text="Tarea")
        self.tree.heading("Start", text="Inicio")
        self.tree.heading("Dur", text="Días")
        self.tree.column("#0", width=150)
        self.tree.column("Start", width=0, stretch=tk.NO) # Oculto por simplicidad
        self.tree.column("Dur", width=50)
        
        main_pane.add(self.tree, width=self.sidebar_width)

        # 4. Canvas del Gantt (Derecha)
        self.canvas_frame = tk.Frame(main_pane)
        self.canvas = tk.Canvas(self.canvas_frame, bg="white")
        
        # Scrollbars para el canvas
        h_scroll = tk.Scrollbar(self.canvas_frame, orient=tk.HORIZONTAL, command=self.canvas.xview)
        v_scroll = tk.Scrollbar(self.canvas_frame, orient=tk.VERTICAL, command=self.canvas.yview)
        self.canvas.configure(xscrollcommand=h_scroll.set, yscrollcommand=v_scroll.set)
        
        h_scroll.pack(side=tk.BOTTOM, fill=tk.X)
        v_scroll.pack(side=tk.RIGHT, fill=tk.Y)
        self.canvas.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        
        main_pane.add(self.canvas_frame)

        # 5. Eventos
        self.canvas.bind("<Button-1>", self.on_mouse_down)
        self.canvas.bind("<B1-Motion>", self.on_mouse_drag)
        self.canvas.bind("<ButtonRelease-1>", self.on_mouse_up)

    def on_zoom_change(self, val):
        self.col_width = int(float(val))
        self.draw_gantt()

    def add_task(self):
        new_id = len(self.tasks) + 1
        new_task = {
            "id": new_id, 
            "name": f"Nueva Tarea {new_id}", 
            "start": strip_time(datetime.datetime.now()), 
            "duration": 5, 
            "color": "#3b82f6",
            "level": 0
        }
        self.tasks.append(new_task)
        self.draw_gantt()

    def draw_gantt(self):
        self.canvas.delete("all")
        self.tree.delete(*self.tree.get_children())

        total_days = 60 # Rango visual fijo para demo
        
        # --- 1. Dibujar Grid y Cabeceras ---
        for i in range(total_days):
            x = i * self.col_width
            date = add_days(self.start_date, i)
            
            # Fondo alterno para fines de semana
            if date.weekday() >= 5:
                self.canvas.create_rectangle(x, 0, x + self.col_width, 1000, fill="#f3f4f6", outline="")
            
            # Líneas verticales
            self.canvas.create_line(x, 0, x, 1000, fill="#e5e7eb")
            
            # Texto Cabecera
            day_str = date.strftime("%d")
            month_str = date.strftime("%b")
            self.canvas.create_text(x + self.col_width/2, 15, text=day_str, font=("Arial", 9, "bold"))
            self.canvas.create_text(x + self.col_width/2, 30, text=month_str, font=("Arial", 7), fill="gray")

        self.canvas.create_line(0, self.header_height, total_days * self.col_width, self.header_height, fill="#d1d5db")

        # --- 2. Dibujar Tareas ---
        for idx, task in enumerate(self.tasks):
            # Actualizar panel izquierdo
            tree_id = self.tree.insert("", "end", text=task["name"], values=(task["start"].strftime("%Y-%m-%d"), f"{task['duration']}d"))
            
            # Calcular posición en Canvas
            days_from_start = date_diff(self.start_date, task["start"])
            x1 = days_from_start * self.col_width
            x2 = x1 + (task["duration"] * self.col_width)
            y1 = self.header_height + (idx * self.row_height) + 5
            y2 = y1 + 30

            # Dibujar Barra (rectángulo redondeado simulado)
            color = task["color"]
            # Guardamos el ID de la tarea en los tags del objeto canvas para identificarlo luego
            rect_tag = f"task_{idx}"
            
            self.canvas.create_rectangle(x1, y1, x2, y2, fill=color, outline="white", width=2, tags=(rect_tag, "bar"))
            self.canvas.create_text(x1 + 5, y1 + 15, text=task["name"], anchor="w", fill="white", font=("Arial", 9), tags=(rect_tag, "text"))

        # Configurar scroll region
        self.canvas.configure(scrollregion=(0, 0, total_days * self.col_width, self.header_height + len(self.tasks) * self.row_height + 50))

    # --- Lógica de Interacción (Razonamiento idéntico a React) ---
    
    def on_mouse_down(self, event):
        # Traducir coordenadas del evento a coordenadas del canvas (por si hay scroll)
        canvas_x = self.canvas.canvasx(event.x)
        canvas_y = self.canvas.canvasy(event.y)
        
        # Encontrar objetos bajo el mouse
        item = self.canvas.find_closest(canvas_x, canvas_y)
        tags = self.canvas.gettags(item)
        
        # Verificar si es una barra de tarea
        task_tag = next((t for t in tags if t.startswith("task_")), None)
        
        if task_tag:
            task_idx = int(task_tag.split("_")[1])
            self.dragging_item = task_idx
            self.drag_data["x"] = canvas_x
            self.drag_data["start_date"] = self.tasks[task_idx]["start"]
            self.drag_data["task_idx"] = task_idx
            
            # Feedback visual (borde negro al seleccionar)
            self.canvas.itemconfig(item, outline="black")

    def on_mouse_drag(self, event):
        if self.dragging_item is not None:
            canvas_x = self.canvas.canvasx(event.x)
            
            # Calcular delta en píxeles y convertir a días (Lógica clave)
            delta_x = canvas_x - self.drag_data["x"]
            days_shift = int(delta_x / self.col_width)
            
            if days_shift != 0:
                original_start = self.drag_data["start_date"]
                new_start = add_days(original_start, days_shift)
                
                # Actualizar datos en tiempo real
                self.tasks[self.dragging_item]["start"] = new_start
                
                # Redibujar para feedback instantáneo
                self.draw_gantt()

    def on_mouse_up(self, event):
        if self.dragging_item is not None:
            self.dragging_item = None
            self.draw_gantt() # Redibujar final para limpiar estados

if __name__ == "__main__":
    app = GanttApp()
    app.mainloop()
