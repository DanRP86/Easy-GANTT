from nicegui import ui, app
from tinydb import TinyDB, Query
from datetime import datetime, timedelta
import pandas as pd
import tempfile
import os

# --- 1. CONFIGURACIÓN Y ESTADO ---
db = TinyDB('db.json')

# Estado global simple para manejar la selección
class State:
    def __init__(self):
        self.selected_id = None

state = State()

# --- 2. FUNCIONES DE EXPORTACIÓN ---

def export_to_excel():
    if not db.all():
        ui.notify('No tasks to export', type='warning')
        return
        
    # Crear DataFrame
    df = pd.DataFrame(db.all())
    # Limpiar columnas (TinyDB usa doc_id interno, lo añadimos si queremos)
    df['id'] = [item.doc_id for item in db.all()]
    
    # Guardar en temporal
    temp_file = tempfile.NamedTemporaryFile(suffix='.xlsx', delete=False)
    df.to_excel(temp_file.name, index=False)
    temp_file.close()
    
    ui.download(temp_file.name, 'van_project_tasks.xlsx')
    ui.notify('Excel downloaded!')

def export_to_outlook():
    """Genera un archivo .ics manual para importar en Outlook/Gmail/Apple"""
    if not db.all():
        ui.notify('No tasks to export', type='warning')
        return
        
    ics_content = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//VanBuilder//V1.2//EN",
        "CALSCALE:GREGORIAN"
    ]
    
    for item in db.all():
        # Formato fecha ICS: YYYYMMDD
        start_str = item['start'].replace('-', '')
        # End date en ICS es exclusivo, y FullCalendar/TinyDB guardan inclusivo o exclusivo dependiendo.
        # Asumimos que el string viene YYYY-MM-DD.
        end_str = item['end'].replace('-', '') if item['end'] else start_str
        
        ics_content.extend([
            "BEGIN:VEVENT",
            f"UID:van-task-{item.doc_id}",
            f"DTSTART;VALUE=DATE:{start_str}",
            f"DTEND;VALUE=DATE:{end_str}",
            f"SUMMARY:{item['title']}",
            "END:VEVENT"
        ])
        
    ics_content.append("END:VCALENDAR")
    
    # Guardar archivo de texto
    temp_file = tempfile.NamedTemporaryFile(mode='w+', suffix='.ics', delete=False, encoding='utf-8')
    temp_file.write('\n'.join(ics_content))
    temp_file.close()
    
    ui.download(temp_file.name, 'van_project_calendar.ics')
    ui.notify('ICS file downloaded. Open it to add to Outlook!')

# --- 3. LÓGICA DE NEGOCIO ---

def get_events():
    """Convierte datos de TinyDB a formato FullCalendar"""
    events = []
    for item in db.all():
        events.append({
            'id': str(item.doc_id),
            'title': item['title'],
            'start': item['start'],
            'end': item['end'],
            'color': item.get('color', '#3788d8'),
            'allDay': True
        })
    return events

def refresh_calendar():
    ui.run_javascript(f'window.vanCalendar.removeAllEvents(); window.vanCalendar.addEventSource({str(get_events())});')

# --- 4. INTERFAZ DE USUARIO (UI) ---

ui.add_head_html('<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>')

# Contenedor Principal (Centrado)
with ui.column().classes('w-full min-h-screen bg-slate-50 items-center p-8'):
    
    # --- CABECERA Y HERRAMIENTAS ---
    with ui.card().classes('w-full max-w-6xl mb-6 p-4'):
        with ui.row().classes('w-full items-center justify-between'):
            
            # Título
            with ui.row().classes('items-center gap-2'):
                ui.icon('directions_car', size='md').classes('text-slate-700')
                ui.label('Van Project Planner').classes('text-xl font-bold text-slate-700')

            # Botones de Exportación
            with ui.row().classes('gap-2'):
                ui.button('Excel', on_click=export_to_excel, icon='table_view').props('flat dense')
                ui.button('Outlook (.ics)', on_click=export_to_outlook, icon='calendar_month').props('flat dense')

        ui.separator().classes('my-4')
        
        # Controles de Tarea (Input)
        with ui.row().classes('w-full items-center gap-4 wrap'):
            new_task_input = ui.input(placeholder='New Task (e.g. Insulation)').classes('flex-grow min-w-[200px]')
            
            color_picker = ui.select({
                '#3788d8': 'Structure (Blue)', 
                '#27ae60': 'Finish (Green)', 
                '#e74c3c': 'Urgent (Red)',
                '#f39c12': 'Electric (Orange)'
            }, value='#3788d8').classes('w-40')
            
            def add_task():
                if not new_task_input.value:
                    ui.notify('Task name is empty', type='negative')
                    return
                
                today = datetime.now().strftime('%Y-%m-%d')
                tomorrow = (datetime.now() + timedelta(days=1)).strftime('%Y-%m-%d')
                
                db.insert({
                    'title': new_task_input.value,
                    'start': today, 'end': tomorrow,
                    'color': color_picker.value
                })
                new_task_input.value = ''
                refresh_calendar()
                ui.notify('Task added')

            ui.button('Add Task', on_click=add_task, icon='add').classes('bg-slate-700 text-white')
            
            ui.space()
            
            # --- BOTÓN DELETE (Definido aquí para tener acceso) ---
            def delete_action():
                if state.selected_id:
                    db.remove(doc_ids=[state.selected_id])
                    state.selected_id = None
                    delete_btn.disable()
                    delete_btn.text = 'Delete Selected'
                    refresh_calendar()
                    ui.notify('Task deleted', type='negative')

            delete_btn = ui.button('Delete Selected', on_click=delete_action, icon='delete') \
                .classes('bg-red-50 text-red-600 border border-red-200') \
                .props('disabled outline')

    # --- CALENDARIO ---
    with ui.card().classes('w-full max-w-6xl h-[600px] shadow-xl no-shadow-border rounded-xl overflow-hidden'):
        ui.element('div').props('id=calendar').classes('w-full h-full font-sans')

    # --- JAVASCRIPT & HANDLERS ---
    
    def on_update_dates(e):
        """Callback cuando arrastras una tarea"""
        event_id = int(e.args['id'])
        db.update({
            'start': e.args['start'].split('T')[0],
            'end': e.args['end'].split('T')[0] if e.args['end'] else None
        }, doc_ids=[event_id])
        ui.notify('Dates updated')

    def on_event_click(e):
        """Callback cuando haces clic en una tarea"""
        event_id = int(e.args['id'])
        state.selected_id = event_id
        
        # Recuperar nombre de la tarea para mostrarlo en el botón
        task = db.get(doc_id=event_id)
        if task:
            delete_btn.text = f'Delete "{task["title"]}"'
            delete_btn.enable()
            delete_btn.update() # Forzar actualización visual
            ui.notify(f'Selected: {task["title"]}')

    def init_calendar():
        events_json = get_events()
        ui.run_javascript(f'''
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {{
                initialView: 'dayGridMonth',
                firstDay: 1, // Lunes
                locale: 'en',
                height: '100%',
                headerToolbar: {{ 
                    left: 'prev,next today', 
                    center: 'title', 
                    right: 'dayGridMonth,listMonth' 
                }},
                editable: true,
                selectable: true,
                events: {str(events_json)},
                
                eventDrop: info => emitEvent('update_event', {{id: info.event.id, start: info.event.start.toISOString(), end: info.event.end ? info.event.end.toISOString() : null}}),
                eventResize: info => emitEvent('update_event', {{id: info.event.id, start: info.event.start.toISOString(), end: info.event.end.toISOString()}}),
                eventClick: info => emitEvent('click_event', {{id: info.event.id}})
            }});
            calendar.render();
            window.vanCalendar = calendar;
        ''')

    ui.on('update_event', on_update_dates)
    ui.on('click_event', on_event_click)
    
    ui.timer(0.1, init_calendar, once=True)

ui.run(title='Van Project V1.2', reload=False)
