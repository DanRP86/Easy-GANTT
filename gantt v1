from nicegui import ui, app
from tinydb import TinyDB, Query
from datetime import datetime, timedelta

# --- 1. CONFIGURATION & DATABASE ---
db = TinyDB('db.json')

# Convert TinyDB data to FullCalendar format
def get_events():
    events = []
    for item in db.all():
        events.append({
            'id': str(item.doc_id),
            'title': item['title'],
            'start': item['start'],
            'end': item['end'],
            'color': item.get('color', '#3788d8'),
            'allDay': True
        })
    return events

# --- 2. BACKEND LOGIC ---

# Global variable to store the currently selected task ID
selected_task_id = None

def handle_add_task():
    if not new_task_input.value:
        ui.notify('Please enter a task name', type='warning')
        return

    today = datetime.now().strftime('%Y-%m-%d')
    # Default duration: 1 day
    tomorrow = (datetime.now() + timedelta(days=1)).strftime('%Y-%m-%d')
    
    db.insert({
        'title': new_task_input.value,
        'start': today, 
        'end': tomorrow,
        'color': color_picker.value
    })
    
    new_task_input.value = '' 
    refresh_calendar()
    ui.notify('Task added successfully')

def handle_update_drop_resize(e):
    """Updates dates when user drags or resizes a bar"""
    event_id = int(e.args['id'])
    
    db.update({
        'start': e.args['start'].split('T')[0],
        'end': e.args['end'].split('T')[0] if e.args['end'] else None
    }, doc_ids=[event_id])
    
    ui.notify('Dates updated')

def handle_event_click(e):
    """Selects the task but DOES NOT delete it yet"""
    global selected_task_id
    selected_task_id = int(e.args['id'])
    
    task = db.get(doc_id=selected_task_id)
    
    # Update UI to show selection
    delete_button.enable()
    delete_button.text = f'Delete "{task["title"]}"'
    ui.notify(f'Selected: {task["title"]}')

def delete_selected_task():
    """Actually deletes the task when the button is pressed"""
    global selected_task_id
    if selected_task_id:
        db.remove(doc_ids=[selected_task_id])
        selected_task_id = None
        
        # Reset button
        delete_button.disable()
        delete_button.text = 'Delete Selected'
        
        refresh_calendar()
        ui.notify('Task deleted')

def refresh_calendar():
    # Reloads events in the frontend
    ui.run_javascript(f'window.vanCalendar.removeAllEvents(); window.vanCalendar.addEventSource({str(get_events())});')

# --- 3. UI / FRONTEND ---

ui.add_head_html('<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>')

# Main Container
with ui.column().classes('w-full h-screen p-6 bg-slate-50'):
    
    # --- Header & Controls ---
    with ui.row().classes('w-full items-center gap-4 mb-2'):
        ui.label('ðŸš Cliff 600 Planner').classes('text-2xl font-bold text-slate-800 mr-4')
        
        # Input Controls
        new_task_input = ui.input(placeholder='New Task Name').classes('w-64 bg-white rounded px-2 shadow-sm')
        
        color_picker = ui.select({
            '#3788d8': 'Blue (Structure)', 
            '#27ae60': 'Green (Finish)', 
            '#e74c3c': 'Red (Critical)',
            '#f39c12': 'Orange (Elec)'
        }, value='#3788d8').classes('w-40')
        
        ui.button('Add Task', on_click=handle_add_task, icon='add').classes('bg-slate-700 text-white shadow-sm')
        
        # Spacer to push delete button to the right
        ui.space()
        
        # SAFE DELETE BUTTON (Disabled by default)
        delete_button = ui.button('Delete Selected', on_click=delete_selected_task, icon='delete') \
            .classes('bg-red-100 text-red-600') \
            .props('disabled')

    # --- Calendar Area ---
    with ui.card().classes('w-full h-full shadow-lg no-shadow-border rounded-xl overflow-hidden'):
        ui.element('div').props('id=calendar').classes('w-full h-full font-sans')

    # --- Javascript Initialization ---
    def init_calendar():
        events_json = get_events()
        ui.run_javascript(f'''
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {{
                // SETTINGS
                initialView: 'dayGridMonth',
                firstDay: 1,  // 1 = Monday
                locale: 'en', // English
                height: '100%',
                
                // HEADER & NAVIGATION
                headerToolbar: {{ 
                    left: 'prev,next today', 
                    center: 'title', 
                    right: 'dayGridMonth,listMonth' // Using listMonth to see more items
                }},

                // INTERACTION
                editable: true,
                selectable: true,
                events: {str(events_json)},
                
                // EVENTS (Connecting JS to Python)
                
                // 1. Drag & Drop / Resize -> Updates Dates
                eventDrop: info => emitEvent('update_event', {{id: info.event.id, start: info.event.start.toISOString(), end: info.event.end ? info.event.end.toISOString() : null}}),
                eventResize: info => emitEvent('update_event', {{id: info.event.id, start: info.event.start.toISOString(), end: info.event.end.toISOString()}}),
                
                // 2. Click -> Selects for deletion
                eventClick: function(info) {{
                    // Visual feedback (change border color temporarily)
                    info.el.style.borderColor = 'black';
                    emitEvent('click_event', {{id: info.event.id}});
                }}
            }});
            calendar.render();
            window.vanCalendar = calendar;
        ''')
    
    # Event Listeners
    ui.on('update_event', handle_update_drop_resize)
    ui.on('click_event', handle_event_click)
    
    # Start
    ui.timer(0.1, init_calendar, once=True)

ui.run(title='Van Project V1.1', reload=False)
